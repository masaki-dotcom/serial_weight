### Arduinoから送信されたシリアルデータをNuxt.jsで表示するには、以下の流れで実装できます。
#### 手順  
- Arduino側でシリアルデータを送信
- Node.jsサーバーでシリアルデータを受信し、WebSocketで配信
- Nuxt.jsでWebSocketを使ってデータを表示


## 1. Arduino側のコード
```js
#include "HX711.h"
#define DT_PIN  3
#define SCK_PIN 2

HX711 scale;
float calibration_factor = 0.0024;  // キャリブレーション値を設定

void setup() {
    Serial.begin(115200);
    scale.begin(DT_PIN, SCK_PIN);
    
    Serial.println("HX711 Initialized. Waiting for data...");
    scale.tare();  // 初期ゼロ点調整
}

void loop() {
   //シリアル通信で"tare"を受け取り、ゼロリセットする処理
    if (Serial.available()) {
        String command = Serial.readStringUntil('\n');
        command.trim();
        if (command == "tare") {
            scale.tare();  // ゼロリセット
            Serial.println("Tare completed");
        }
    }

    if (scale.is_ready()) {
      //long reading = scale.get_units(10); // 10回の平均を取得
      float reading = scale.get_units(10) * calibration_factor;  // キャリブレーション適用
        Serial.print("Weight: ");
        Serial.print(reading);
        Serial.println(" g");
    } else {
        Serial.println("not ready..........");
    }
    
    delay(100);
}
```

## 2. Node.jsサーバーでシリアルデータを受信  
Node.jsでserialportとwsパッケージを使い、シリアルデータをWebSocket経由で配信します。

### 2-1. 必要なパッケージをインストール
```
npm install serialport ws
```

### 2-2. Node.jsサーバースクリプト
```js
const { SerialPort } = require("serialport");
const { ReadlineParser } = require("@serialport/parser-readline");
const WebSocket = require("ws");
const http = require("http");

// シリアルポート設定
const port = new SerialPort({ path: "COM8", baudRate: 9600 });
const parser = port.pipe(new ReadlineParser({ delimiter: "\r\n" }));

// HTTPサーバーを作成
const server = http.createServer((req, res) => {
  res.writeHead(200, { "Content-Type": "text/plain" });
  res.end("WebSocket server is running\n");
});

// WebSocketサーバーを作成
const wss = new WebSocket.Server({ server });

wss.on("connection", (ws) => {
  console.log("Client connected");

  parser.on("data", (data) => {
    console.log("Arduino Data:", data);

    // 温度と湿度のフォーマットを確認し、適切に送信
    const match = data.match(/温度:\s*([\d.]+)\s*C.*湿度:\s*([\d.]+)%/);
    if (match) {
      const temperature = match[1];
      const humidity = match[2];
      ws.send(JSON.stringify({ temperature, humidity }));
    }
  });

  ws.on("close", () => console.log("Client disconnected"));
});

// サーバーを起動
server.listen(8080, () => {
  console.log("Server running on http://localhost:8080/");
});
```
## 3. Nuxt.jsでWebSocketを使用してデータを表示
### 3-1. WebSocketプラグインを作成
plugins/websocket.js を作成し、以下のコードを記述。
```js
export default ({ app }, inject) => {
    if (process.client) {
      const socket = new WebSocket("ws://localhost:8080");
  
      socket.onopen = () => console.log("WebSocket Connected");
      socket.onmessage = (event) => console.log("Received:", event.data);
      socket.onerror = (error) => console.error("WebSocket Error:", error);
      socket.onclose = () => console.log("WebSocket Disconnected");
  
      inject("socket", socket);
    }
  };
  ```

  ### 3-2. プラグインをNuxtに登録
  nuxt.config.js に以下を追加。
  ```js
  plugins: [
    { src: "~/plugins/websocket.js", mode: "client" }
  ],
```

### 3-3. Vueコンポーネントで表示
pages/index.vue でWebSocketのデータを受信し、表示。
```js
<template>
  <div>
    <h1>Arduino Data:</h1>
    <h2>気温：{{ message.temperature }} ℃　　　湿度：{{ message.humidity }} ％</h2>
  </div>
</template>

<script>
export default {
  data() {
    return {
      message: "Waiting for data...",
    };
  },
  mounted() {
    if (this.$socket) {
      this.$socket.onmessage = (event) => {

        console.log(event.data)
        this.message = JSON.parse(event.data);
      };
    } else {
      console.error("WebSocket connection failed");
    }
  },
};
</script>
```
## 動作確認

Node.jsサーバーを起動
```
node server.js
```

Nuxt.jsを起動
```
npm run dev
```


## PM2 で Node.js のデーモン化 
- PM2 のインストール
```
 npm install -g pm2
 ``` 

 - PM2 にアプリを登録
 同じファルダ内にserver.jsがある場合
```
pm2 start server.js --name LoadCell-server 
pm2 save
```

- PM2 をスタート・ストップ
```
pm2 start LoadCell-server
pm2 stop LoadCell-server
```

- PM2 をスタートアップに登録
pm2_startup.batを作成  

```
@echo off
pm2 resurrect  
```

- PM2 を完全に停止する場合は
これにより、PM2 で管理されているすべてのプロセスが停止し、PM2 自体も終了します。
```
 pm2 kill
 ```

 - PM2 を完全に停止する場合は
これにより、PM2 で管理されているすべてのプロセスが停止し、PM2 自体も終了します。
```
 pm2 kill
 ```

  - ス再起動する場合
  ```
  pm2 restart all
  ```

 ```java
 #include "HX711.h"

// HX711のDTとSCKピンを指定
#define DT_PIN  3
#define SCK_PIN 2

HX711 scale;
//float calibration_factor = 0.0024;  // キャリブレーション値を設定

void setup() {
    Serial.begin(115200);
    scale.begin(DT_PIN, SCK_PIN);
    
    
    Serial.println("HX711 Initialized. Waiting for data...");
    
    
    scale.tare();  // ゼロ点調整
}

void loop() {
    if (scale.is_ready()) {
        long reading = scale.get_units(80); // 10回の平均を取得
//       float reading =scale.get_units(80) * calibration_factor;  // キャリブレーション適用
        Serial.print("Weight: ");
        Serial.print(reading);
        Serial.println(" g"); // 必要なら単位を変更
    } else {
        Serial.println("HX711 not ready");
    }
    
    delay(1000);
}
```


arduino-1.8.19-windows.exe